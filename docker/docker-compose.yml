version: "3"

##################################################
# docker compose 設定（開発環境）
#-------------------------------------------------
# メモ：
# このファイルで利用している変数は
# ローカルマシンの環境変数として定義されています。
# （.env ファイルで、さらに定義を追加しています）
##################################################

##############################
# サービス
##############################
services:

  ##############################
  # java
  ##############################
  backend:
    container_name: ${COMPOSE_PROJECT_NAME}-java
    build:
      context: ../sbdemo/
      target: dev # Dockerfileに定義されたdevステージの設定を利用
      args:
        # Dockerfile に渡すビルド引数
        JAVA_VERSION: ${JAVA_VERSION}
        USER_NAME: ${USER_NAME}
        USER_UID: ${USER_UID}
        USER_GID: ${USER_GID}
    ports:
      - 8080:8080
    tty: true
    volumes:
      - type: bind
        source: ..
        target: /workspace
        consistency: cached
    working_dir: /workspace/sbdemo
    depends_on:
      - mysql # mysql の後で起動

  ##############################
  # nextjs
  ##############################
  frontend:
    container_name: ${COMPOSE_PROJECT_NAME}-nextjs
    build:
      context: ../nextjs/
      target: dev
      args:
        # Dockerfile に渡すビルド引数
        USER_NAME: ${USER_NAME}
        USER_UID: ${USER_UID}
        USER_GID: ${USER_GID}
    ports:
      - 3000:3000
    tty: true
    volumes:
      - type: bind
        source: ..
        target: /workspace
        consistency: cached
    working_dir: /workspace/nextjs
    # command: yarn dev
    stdin_open: true # 標準入力（stdin）を開く

  ##############################
  # mysql
  ##############################
  mysql:
    container_name: ${COMPOSE_PROJECT_NAME}-mysql
    build:
      context: ../mysql/
      target: dev
    env_file:
      - ./db.env
    ports:
      - "${DB_PORT-3306}:3306"
    volumes:
      - mysql-local:/var/lib/mysql # 実データの永続化（名前付きボリュームを指定）

##############################
# 名前付きボリューム
##############################
volumes:
  mysql-local:
